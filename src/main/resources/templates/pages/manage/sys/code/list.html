<!DOCTYPE html>
<html lang="en"
	  class="light-style layout-menu-fixed"
	  dir="ltr"
	  data-theme="theme-default"
	  data-assets-path="/manage/assets/"
	  data-template="vertical-menu-template-free"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{common/manage/layout/layout}"
	  layout:fragment="content"
>
<script th:inline="javascript">

	// code 상세정보 불러오기
	function fnGetCodeInfo(code){
		fetch('/ma/sys/code/getCodeDetail', {
			method: "POST",
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				code: code
			})
		})
				.then(res => res.json())
				.then(data => {
					document.getElementById("groupCode").value = data.codeDetail.groupCode;
					document.getElementById("parentCode").value = data.codeDetail.parentCode;
					document.getElementById("code").value = data.codeDetail.code;
					document.getElementById("name").value = data.codeDetail.name;
					document.getElementById("useYn").value = data.codeDetail.useYn;
					document.getElementById("order").value = data.codeDetail.order;
				})
				.catch(error => alert('fetch 에러'));
	}

	// 해당 code 하위리스트 불러오기
	function fnGetCodeList(parentCode, id){

		fnGetCodeInfo(parentCode);

		const obj_size = document.getElementsByClassName(parentCode).length;
		if(obj_size > 0){
			for (i = 1; i < obj_size+1; i++) {
				document.getElementById(parentCode+"_"+ i).remove();
			}
			return false;
		}

		fetch('/ma/sys/code/getCodeList', {
			method: "POST",
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				parentCode: parentCode

			})
		})
				.then(res => res.json())
				.then(data => {
					if(data.codeList.length > 0) {
						data.codeList.forEach((value, index) => {
							let content = '';
							if(id != ''){
								content += '<td onCLick="fnGetCodeList(\'' + value.code + '\', \'' + (parentCode + "_" + value.order) + '\')" colspan=\"2\" style=\"text-align: right\"> - ' + value.order + ' - </td>' +
										   '<td onCLick="fnGetCodeList(\'' + value.code + '\', \'' + (parentCode + "_" + value.order) + '\')">' + value.name + '</td>';
								const tr_box = document.createElement("tr");
								tr_box.id = (parentCode + "_" + value.order);
								tr_box.className = parentCode;
								tr_box.innerHTML = content;
								document.getElementById(id).after(tr_box);
							}else{
								content += '<td onCLick="fnGetCodeList(\'' + value.code + '\', \'' + (parentCode + "_" + value.order) + '\')" colspan=\"2\" style=\"text-align: right\">(' + value.order + ')</td>' +
										'<td onCLick="fnGetCodeList(\'' + value.code + '\', \'' + (parentCode + "_" + value.order) + '\')">' + value.name + '</td>';
								const tr_box = document.createElement("tr");
								tr_box.id = (parentCode + "_" + value.order);
								tr_box.className = parentCode;
								tr_box.innerHTML = content;
								document.getElementById(parentCode).after(tr_box);
							}
						});
					}
				})
				.catch(error => alert('fetch 에러'));
	}

	function  fnReset(){
		document.getElementById("groupCode").value = '';
		document.getElementById("parentCode").value = '';
		document.getElementById("code").value = '';
		document.getElementById("name").value = '';
		document.getElementById("useYn").value = 'Y';
		document.getElementById("order").value = '';
	}
</script>
<h4 class="fw-bold py-3 mb-4">CODE</h4>
<div>
	<form id="defaultFrm" th:object="${maCodeDto}" method="post" onsubmit="return false;">
		<input type="hidden" th:field="*{seq}"/>
		<div>
			<div class="card" style="width:40%;display: inline-block;margin-right: 3%;">
				<div class="card-header">
				<table class="datatables-users table border-top dataTable no-footer dtr-column">
					<colgroup>
						<col style="width:15%;">
						<col style="width:10%;">
						<col style="width:75%;">
					</colgroup>
					<thead>
					<tr>
						<th>No.</th>
						<th th:colspan="2">코드명</th>
					</tr>
					</thead>
					<tbody id="tbody">
					<th:block th:if="${#lists.size(resultList) gt 0}">
						<tr th:id="${result.code}" varStatus="status" class="text-body" th:each="result, status : ${resultList}" onclick="fnGetCodeList(this.getAttribute('parameter'),'')" th:parameter="${result.code}"  style="cursor: pointer;">
							<td th:text="${status.count}"></td>
							<td th:colspan="2" th:text="${result.name}"></td>
						</tr>
					</th:block>
					</tbody>
				</table>
				</div>
			</div>
			<div class="card" style="display: inline-block; position: absolute">
				<div class="card-header">
					<form id="defaultFrm" th:object="${maCodeDto}" method="post" onsubmit="return false;">
						<input type="hidden" id="seq" name="seq" th:value="${maCodeDto.seq}">
						<div class="row">
							<div class="col-md-4 col-md-6">
								<label for="title" class="form-label">그룹코드</label>
								<input type="text" class="form-control" id="groupCode" name="groupCode" th:value="${maCodeDto.groupCode}" title="부모코드"/>
							</div>
							<div class="col-md-4 col-md-6">
								<label for="title" class="form-label">부모코드</label>
								<input type="text" class="form-control" id="parentCode" name="parentCode" th:value="${maCodeDto.parentCode}" title="부모명"/>
							</div>
						</div>
						<div class="row">
							<div class="col-md-4 col-md-12">
								<label for="title" class="form-label">코드</label>
								<input type="text" class="form-control" id="code" name="code" th:value="${maCodeDto.code}" title="코드" required/>
							</div>
						</div>
						<div class="row">
							<div class="col-md-4 col-md-12">
								<label for="title" class="form-label">코드명</label>
								<input type="text" class="form-control" id="name" name="name" th:value="${maCodeDto.name}" title="코드명" required/>
							</div>
						</div>
						<div class="row">
							<div class="col-md-4 col-md-6">
								<label for="title" class="form-label">순서</label>
								<input type="text" class="form-control" id="order" name="order" th:value="${maCodeDto.order}" title="순서" required/>
							</div>
							<div class="col-md-4 col-md-6">
								<label for="title" class="form-label">사용여부</label>
								<select class="form-select" id="useYn" name="useYn" th:value="${maCodeDto.useYn}" title="공개여부" required>
									<option value="Y" th:selected="${maCodeDto.useYn} == 'Y'">사용</option>
									<option value="N" th:selected="${maCodeDto.useYn} == 'N'">미사용</option>
								</select>
							</div>
						</div>
						<div class="text-end" style="margin-top: 20px;">
							<button type="button" class="btn btn-outline-info" onclick="fnReset()">초기화</button>
							<button id="btn_save" type="button" class="btn btn-outline-primary" onclick="gfnPageProcess('submit', 'insertProc')">등록</button>
							<button type="button" class="btn btn-outline-danger" onclick="gfnPageProcess('submit', 'deleteProc')">삭제</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</form>
</div>
</html>
